<?php defined('IN_ADMIN') or die("not here"); // make vsc fmt happy ?>
<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Admin Panel</title>

    <link rel="stylesheet" href="bootstrap-5.3.1/css/bootstrap.min.css?v=c24439e7a4bbb5d8782a14cd4e1cd4a0">

    <script src="../js/jquery-3.6.4.min.js?v=954f70f07f05742168adceba796dda72"></script>
    <script src="../js/jquery.cookie.min.js?v=34f2c35185e06a0fad464f954b00d3dc"></script>
    <script src="../js/layer.min.js?v=7cdb23d7e49febe634c90bcd40470bea"></script>

    <script src="bootstrap-5.3.1/js/bootstrap.min.js?v=6238f01f41a10bf7282287b6f3ea2fdd"></script>

    <!-- 引入 admin.js -->
    <script src="js/admin.js?v=16b4404ff64a434b5726e98dc36aa61c"></script>
    <!-- 引入 admin.css -->
    <link rel="stylesheet" type="text/css" href="css/admin.css?v=dcd3323415bb9722c8116a267fc7a90e">
    <?php echo "<script>var user = " . json_encode($_SESSION['user']) . ";</script>"; ?>
    <?php echo "<script>var result = " . json_encode($jsResult) . ";</script>"; ?>
</head>

<body>
    <div class="login-area">
        <h4 id="welcome"></h4>
        <a class="btn" id="login" href="adminxlogin.php">登录</a>
        <a class="btn" id="logout" style="display: none;" href="adminxlogin.php?action=logout">登出</a>
    </div>

    <?php include 'block_nav.html'; ?>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <div style="width: 80%;margin:  10px auto;">
        <h3>用户统计</h3>
        <select id="timeFilter">
            <option value="30">最近30天</option>
            <option value="60">最近2个月 (60天)</option>
            <option value="90">最近3个月 (90天)</option>
            <option value="120">最近4个月 (120天)</option>
        </select>
        <canvas id="userChart"></canvas>
        <canvas id="statisticsChart"></canvas>
    </div>

    <script>

        // 当选择框的值发生变化时触发事件
        $("#timeFilter").change(function () {
            // 获取选择框的值
            var selectedTime = $(this).val();

            // 使用ajax从接口获取数据
            $.ajax({
                url: "?",
                method: "GET",
                data: { days: selectedTime },
                success: function (data) {
                    // 数据获取成功后，更新图表
                    updateUserChart(data);
                    updateStatisticsChart(data);
                },
                error: function (error) {
                    console.error("Error fetching data:", error);
                }
            });
        });

        // 更新图表数据
        function updateUserChart(data) {
            data = data.users; // 更新为用户表的数据
            // 根据接口返回的数据更新图表的标签和数据
            userChart.data.labels = data.map(entry => entry.date);
            userChart.data.datasets[0].data = data.map(entry => entry.count);
            userChart.data.datasets[1].data = data.map(entry => entry.click_count);

            // 重新绘制用户图表
            userChart.update();
        }

        function updateStatisticsChart(data) {
            data = data.statistics; // 更新为统计表的数据
            // 根据接口返回的数据更新图表的标签和数据
            statisticsChart.data.labels = data.map(entry => entry.date);
            statisticsChart.data.datasets[0].data = data.map(entry => entry.total_points);
            statisticsChart.data.datasets[1].data = data.map(entry => entry.day_points);

            // 重新绘制统计图表
            statisticsChart.update();
        }

        const userChartCtx = document.getElementById('userChart');
        const userLabels = result.users.map(entry => entry.date); // 使用从PHP获取的日期数据
        const userData = {
            labels: userLabels,
            datasets: [
                {
                    label: '用户数量',
                    data: result.users.map(entry => entry.count),
                    fill: false,
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1
                },
                {
                    label: '点击充值对话框数量',
                    data: result.users.map(entry => entry.click_count),
                    fill: false,
                    borderColor: 'rgb(255, 99, 132)',
                    tension: 0.1
                }
            ]
        };
        const userChartConfig = {
            type: 'line',
            data: userData,
        };
        const userChart = new Chart(userChartCtx, userChartConfig);

        const statisticsChartCtx = document.getElementById('statisticsChart');
        const statisticsLabels = result.statistics.map(entry => entry.date); // 使用从PHP获取的日期数据
        const statisticsData = {
            labels: statisticsLabels,
            datasets: [
                {
                    label: '消耗的总积分',
                    data: result.statistics.map(entry => entry.total_points),
                    fill: true,
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1
                },
                {
                    label: '每天消耗的积分',
                    data: result.statistics.map(entry => entry.day_points),
                    fill: true,
                    borderColor: 'rgb(192, 75, 75)',
                    tension: 0.1
                }
            ]
        };
        const statisticsChartConfig = {
            type: 'line',
            data: statisticsData,
        };
        const statisticsChart = new Chart(statisticsChartCtx, statisticsChartConfig);

    </script>

</body>

</html>